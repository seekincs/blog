---
author: "Trayvon Pan"
title: "最快的IPC：共享内存"
date: 2022-07-12T10:35:29+08:00
draft: false
description: ""
tags: ["IPC"]
toc: false
---

为什么共享内存是最快的 IPC 形式？<b>简单来说，是因为共享内存区可以映射到进程的地址空间，那么这些进程之间的数据传递就不再涉及内核，避免了相对耗时的模态切换和系统调用。</b>不过，使用共享内存的进程之间读写数据时，也需要某种形式的同步机制。

<!--more-->

## 管道、FIFO 和消息队列为什么慢

假设进程 P1 需要向进程 P2 发送一个文件。通常情况下，需要经过几个步骤：

1、P1 通过 read 将输入文件**拷贝**到自己的进程空间；</br>
2、P1 通过 write 或 mq_send 把数据**拷贝**到内核的管道、FIFO 或消息队列；</br>
3、内核负责把 管道、FIFO 或消息队列的数据**拷贝**到 P2 的进程空间；</br>
4、进程 P2 通过 write 把数据**拷贝**到输出文件。

![pipe-fifo-mq](pipe-fifo-mq.png)

可见，整个过程一共需要 4 次数据拷贝，并且注意到，每次拷贝都是在内核和用户进程之间进行的，因此需要 4 次用户态和内核态之间的切换，这个模态切换的开销是相当大的。而且，这仅仅是 P1 向 P2 传送数据的开销，如果 P1 和 P2 需要频繁互相交换数据，那么这个开销将会更大。**本质上，管道、FIFO 和消息队列这三种 IPC 形式的问题在于，不同进程之间的数据交换都需要经过内核。**

那能不能绕开内核呢？答案是肯定的，共享内存提供了一种可行的解决方案。不同的进程可以访问一块预先分配的共享内存，内核会把这块内存的地址空间映射到每个进程自己的地址空间，进程只访问自己的地址空间，内核会维护这些进程空间和共享内存空间的数据一致性。由于这些进程会竞争性地读写数据，所以必须协调和同步进程对共享内存的使用，比如互斥锁、读写锁、信号量等等。

## 地址空间的映射

这通常可以由 mmap（https://man7.org/linux/man-pages/man2/mmap.2.html）来完成。
**mmap 函数把一个文件映射到调用该函数的进程的地址空间。** mmap 函数的原型为：

```c
#include <sys/mman.h>
// 若成功则为被映射区的起始地址，出错返回 MAP_FAILED
void *mmap(void *addr, size_t length, int prot,
    int flags, int fd, off_t offset);
```

其中 addr 指定 fd 应该映射到进程空间的起始地址。通常情况下可以指定为空指针，让内核自己去决定起始地址。flags 用来选择可见性。如果 flags=MAP_SHARED，表明一个进程对映射数据的更改是共享的，其他进程可以同步到这个更改；如果 flags=MAP_PRIVATE，那么进程对映射数据的改动只对本进程可见。

![mmap](mmap.png)

对于 flags=MAP_SHARED 这种情况而言，实际的数据保存在一个文件里面，各个进程把文件的数据映射到自己的空间进行读写。这就可能产生一个问题：怎么保证映射的数据和文件是一致的？（在分布式系统也有类似的问题，比如各个服务都单独拷贝了一份数据库的数据在本地的缓存，但需要保持缓存和数据库的一致性。）这是由内核来完成的。内核通过虚拟内存算法保证文件与映射内存的同步。如果一个进程修改了映射内存的数据，那么就会在稍后某个时刻相应地更改文件（可以参考内存和磁盘的同步机制）。当然，内核什么时候写回磁盘，我们是不知道的。有时候，我们希望确定磁盘上的文件和映射内存的内容一致，可以通过调用 msync（https://man7.org/linux/man-pages/man2/msync.2.html）来完成。

```c
#include <sys/mman.h>
int msync(void *addr, size_t length, int flags);
```

Posix.1 提供了两种在无亲缘关系进程间共享内存的方法：内存映射文件和内存映射对象。前者由 open 函数打开文件得到一个 fd；后者由 shm_open （https://man7.org/linux/man-pages/man3/shm_open.3.html）打开一个 Posix.1 IPC 名字（可以是文件路径，也可以是其他），然后 mmap 将其映射到进程空间。共享内存的大小可以通过 ftruncate（https://man7.org/linux/man-pages/man3/ftruncate.3p.html）来调整。
